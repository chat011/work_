<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Products - Fashion Scraper</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-blue: #3b82f6;
            --success-green: #10b981;
            --error-red: #ef4444;
            --warning-yellow: #f59e0b;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --border-light: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            border: 2px solid #e2e8f0;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .table-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-light);
        }

        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px 24px;
            border-bottom: 2px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .editable-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .editable-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 6px;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .editable-table td {
            padding: 4px 3px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
            background: white;
            transition: all 0.2s ease;
        }

        .editable-table tr:hover td {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            transform: scale(1.001);
        }

        .editable-table tr:nth-child(even) td {
            background: #fafbfc;
        }

        .editable-table tr:nth-child(even):hover td {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }

        .editable-cell {
            width: 100%;
            border: 1px solid #e2e8f0;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            background: #f8fafc;
            transition: all 0.2s ease;
            resize: none;
            min-height: 28px;
            font-family: inherit;
            color: var(--text-primary);
            position: relative;
            line-height: 1.3;
            overflow: hidden;
        }

        .editable-cell:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .editable-cell:focus {
            outline: none;
            border-color: var(--accent-purple);
            background: white;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.12);
            z-index: 1;
        }

        .editable-cell.modified {
            background: #fef3c7;
            border-color: #f59e0b;
            position: relative;
        }

        .editable-cell.modified::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 6px;
            height: 6px;
            background: #f59e0b;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(245, 158, 11, 0.3);
        }

        @keyframes highlightModified {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .editable-cell:invalid {
            border-color: var(--error-red);
            background: #fef2f2;
        }

        .editable-cell:invalid:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.12);
        }

        .editable-cell::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        .product-image-cell {
            width: 90px;
            text-align: center;
        }

        .product-image-preview {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-light);
            margin: 1px;
            cursor: pointer;
            transition: transform 0.2s ease;
            position: relative;
        }

        .product-image-preview:hover {
            transform: scale(1.2);
            border-color: var(--accent-purple);
        }

        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            max-width: 90px;
            justify-content: center;
        }

        .image-wrapper {
            position: relative;
            display: inline-block;
        }

        .image-remove-btn {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 14px;
            height: 14px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .image-wrapper:hover .image-remove-btn {
            display: flex;
        }

        .image-remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        .image-sizes-dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .image-sizes-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 6px 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .image-sizes-toggle:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }

        .image-sizes-toggle .fa-chevron-down {
            font-size: 0.6rem;
            transition: transform 0.2s ease;
        }

        .image-sizes-toggle.open .fa-chevron-down {
            transform: rotate(180deg);
        }

        .image-sizes-count {
            background: var(--accent-purple);
            color: white;
            border-radius: 10px;
            padding: 1px 6px;
            font-size: 0.6rem;
            margin-right: 4px;
        }

        .image-sizes-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            box-shadow: var(--shadow-md);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 4px;
        }

        .image-sizes-dropdown-content.show {
            display: block;
        }

        .image-size-item {
            padding: 6px 8px;
            font-size: 0.7rem;
            border-bottom: 1px solid #f1f5f9;
            color: var(--text-secondary);
        }

        .image-size-item:last-child {
            border-bottom: none;
        }

        .image-size-item:hover {
            background: #f8fafc;
        }

        .add-image-btn {
            width: 32px;
            height: 32px;
            border: 2px dashed var(--border-light);
            border-radius: 4px;
            background: var(--bg-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 12px;
            transition: all 0.2s ease;
            margin: 1px;
        }

        .add-image-btn:hover {
            border-color: var(--accent-purple);
            background: var(--accent-purple);
            color: white;
        }

        .image-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            right: 2px;
            border: 1px solid white;
        }

        .image-available {
            background-color: var(--success-green);
        }

        .image-unavailable {
            background-color: var(--error-red);
        }

        .availability-select {
            padding: 4px 6px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            width: 100%;
        }

        .availability-select:hover {
            border-color: #cbd5e1;
        }

        .availability-select:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.12);
        }

        .availability-select.in-stock {
            background: #f0fdf4;
            color: #166534;
            border-color: #22c55e;
        }

        .availability-select.out-of-stock {
            background: #fef2f2;
            color: #991b1b;
            border-color: #ef4444;
        }

        .availability-select.limited {
            background: #fef3c7;
            color: #92400e;
            border-color: #f59e0b;
        }

        .availability-select.preorder {
            background: #e0f2fe;
            color: #1e40af;
            border-color: #3b82f6;
        }

        .image-url-input {
            width: 200px;
            font-size: 0.8rem;
        }

        .tags-input {
            min-height: 32px;
            background: #f8fafc;
            border-left: 2px solid var(--accent-purple);
        }

        .tags-input:focus {
            border-left-color: var(--accent-pink);
            background: white;
        }

        .price-input {
            text-align: right;
            font-weight: 600;
            color: var(--success-green);
            background: #f0fdf4;
        }

        .price-input:focus {
            background: white;
            color: var(--text-primary);
        }

        .description-input {
            min-height: 40px;
            background: #fefefe;
            line-height: 1.3;
        }

        .name-input {
            font-weight: 600;
            font-size: 0.8rem;
            background: #fefefe;
            border-left: 2px solid var(--accent-purple);
        }

        .name-input:focus {
            border-left-color: var(--accent-pink);
        }

        .row-actions {
            display: flex;
            gap: 2px;
            align-items: center;
            justify-content: center;
        }

        .row-btn {
            padding: 4px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .row-btn:hover {
            transform: scale(1.1);
        }

        .row-btn.delete {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #f87171;
        }

        .row-btn.delete:hover {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }

        .row-btn.duplicate {
            background: #e0e7ff;
            color: #1e40af;
            border: 1px solid #6366f1;
        }

        .row-btn.duplicate:hover {
            background: #6366f1;
            color: white;
            border-color: #4f46e5;
        }

        .row-btn.view {
            background: #e0f2fe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .row-btn.view:hover {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .row-btn.view:disabled {
            background: #f1f5f9;
            color: #9ca3af;
            border-color: #e5e7eb;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .row-btn.view:disabled:hover {
            background: #f1f5f9;
            color: #9ca3af;
            transform: none;
        }

         /* Premium toggle button styles */
        .premium-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .premium-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .toggle-slider:hover {
            box-shadow: 0 0 5px rgba(139, 92, 246, 0.5);
        }

        .premium-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .premium-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .description-input {
            min-height: 40px;
            max-height: 120px;
            background: #fefefe;
            line-height: 1.3;
            overflow-y: auto;
            resize: vertical;
        }

        .dropdown-container {
            position: relative;
            max-width: 100%;
        }

        .dropdown-toggle {
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 6px 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dropdown-toggle:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            box-shadow: var(--shadow-md);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 4px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-search {
            padding: 8px 12px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .dropdown-search input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .dropdown-options {
            max-height: 150px;
            overflow-y: auto;
        }

        .dropdown-item {
            padding: 6px 12px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .dropdown-item:hover {
            background-color: #f1f5f9;
        }

        .selected-options {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .selected-tag {
            background: var(--accent-purple);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .selected-tag .remove {
            margin-left: 4px;
            cursor: pointer;
            font-size: 0.6rem;
        }

        .color-option {
            display: flex;
            align-items: center;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid #e2e8f0;
        }

        .truncated-text {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stats-bar {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px 24px;
            border-top: 2px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .stats-left {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .stats-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--accent-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-green);
        }

        .notification.error {
            background: var(--error-red);
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .editable-table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-edit"></i> Edit Products</h1>
            <p>Review and edit your scraped products before uploading. Click on any cell to edit its content.</p>
            <div id="taskInfo" style="display: none; margin-bottom: 16px; padding: 12px; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0288d1;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-info-circle" style="color: #0288d1;"></i>
                    <span><strong>Task ID:</strong> <span id="currentTaskId"></span></span>
                    <span style="margin-left: 16px;"><strong>Scraper Type:</strong> <span id="scraperType"></span></span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.close()">
                    <i class="fas fa-arrow-left"></i> Back to Scraper
                </button>
                <button class="btn btn-secondary" onclick="addNewProduct()">
                    <i class="fas fa-plus"></i> Add Product
                </button>
                <button class="btn btn-secondary tooltip" onclick="toggleKeyboardHelp()" data-tooltip="View keyboard shortcuts">
                    <i class="fas fa-keyboard"></i> Shortcuts
                </button>
                <button class="btn btn-primary" onclick="exportData()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <button class="btn btn-success" onclick="uploadProducts()">
                    <i class="fas fa-cloud-upload-alt"></i> Upload Products
                </button>
            </div>
        </div>

        <div class="table-container">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-table"></i>
                    <span>Product Data Table</span>
                </div>
                <div class="table-actions">
                    <button class="btn btn-secondary" onclick="selectAllRows()">
                        <i class="fas fa-check-square"></i> Select All
                    </button>
                    <button class="btn btn-secondary" onclick="deleteSelectedRows()">
                        <i class="fas fa-trash"></i> Delete Selected
                    </button>
                </div>
            </div>

            <div style="overflow-x: auto; max-height: 70vh;">
                <table class="editable-table" id="productsTable">
                    <thead>
                        <tr>
                            <th width="25">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th width="90">Images</th>
                            <th>Image Sizes</th>
                            <th width="200">Product Name</th>
                            <th width="80">Price</th>
                            <th width="80">Disc. Price</th>
                            <th width="90">Status</th>
                            <th width="180">Description</th>
                            <th width="100">Sizes</th>
                            <th width="100">Colors</th>
                            <th width="80">Material</th>
                            <th width="100">Categories</th>
                            <th width="75">Actions</th>
                            <th width="60">Premium</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Products will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="stats-bar">
                <div class="stats-left">
                    <span><strong id="totalProducts">0</strong> products</span>
                    <span><strong id="modifiedProducts">0</strong> modified</span>
                    <span><strong id="selectedProducts">0</strong> selected</span>
                    <span><strong id="premiumProducts">0</strong> premium</span>
                </div>
                <div class="stats-right">
                    <button class="btn btn-secondary" onclick="resetChanges()">
                        <i class="fas fa-undo"></i> Reset Changes
                    </button>
                    <button class="btn btn-secondary" onclick="saveChanges()">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Uploading Products...</h3>
            <p>Please wait while we process your data.</p>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="keyboardHelpModal" class="loading-overlay" style="display: none;">
        <div class="loading-content" style="max-width: 500px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: var(--text-primary);">
                    <i class="fas fa-keyboard" style="margin-right: 8px; color: var(--accent-purple);"></i>
                    Keyboard Shortcuts
                </h3>
                <button onclick="toggleKeyboardHelp()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent-purple);">
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>Save Changes</strong></span>
                        <kbd style="background: var(--accent-purple); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Ctrl + S</kbd>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>Export Data</strong></span>
                        <kbd style="background: var(--accent-purple); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Ctrl + E</kbd>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>Clear Focus</strong></span>
                        <kbd style="background: var(--accent-purple); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Escape</kbd>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>Navigate Cells</strong></span>
                        <kbd style="background: var(--accent-purple); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">Tab / Shift + Tab</kbd>
                    </div>
                </div>
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e2e8f0; font-size: 0.9rem; color: var(--text-secondary);">
                    <i class="fas fa-info-circle" style="margin-right: 6px; color: var(--accent-blue);"></i>
                    Auto-save is enabled every 30 seconds for modified products.
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variable to store options data
        let optionsData = {
            colors: [],
            sizes: [],
            materials: [],
            categories: []
        };

        // Function to fetch options data from API
        async function fetchOptionsData() {
            try {
                // In a real implementation, you would fetch from the actual API
                // For demo purposes, we'll use the sample data you provided
                const sampleData = {
                    "status": true,
                    "message": "Option data & categories retrieved successfully",
                    "data": {
                        "colorOptions": [{
                            "_id": "601a67fd4e966936d4f475d4",
                            "option_name": "Color",
                            "option_values": [
                                {"status": "1", "_id": "6509a8b877379f22b05e17a1", "option_value_name": "Beige", "sort_order": 21, "color_code": "#f5f5dc"},
                                {"status": "1", "_id": "6509a8b877379f22b05e1791", "option_value_name": "Black", "sort_order": 5, "color_code": "#000000"},
                                {"status": "1", "_id": "64ca7b8880532780f4a1dddb", "option_value_name": "Blue", "sort_order": 1, "color_code": "#0000ff"},
                                {"status": "1", "_id": "6509a8b877379f22b05e17df", "option_value_name": "Bronze", "sort_order": 48, "color_code": "#aa6c39"},
                                {"status": "1", "_id": "6509a8b877379f22b05e17a9", "option_value_name": "Brown", "sort_order": 27, "color_code": "#a52a2a"}
                            ]
                        }],
                        "sizeOptions": [{
                            "_id": "601a68b54e966936d4f475db",
                            "option_name": "Size",
                            "option_values": [
                                {"status": "1", "_id": "6554e4b70d9254bece34f663", "option_value_name": "Free size", "sort_order": 1, "color_code": ""},
                                {"status": "1", "_id": "60547418e1680a3111d00735", "option_value_name": "XS", "sort_order": 2, "color_code": ""},
                                {"status": "1", "_id": "60547418e1680a3111d00736", "option_value_name": "S", "sort_order": 3, "color_code": ""},
                                {"status": "1", "_id": "60547418e1680a3111d00737", "option_value_name": "M", "sort_order": 4, "color_code": ""},
                                {"status": "1", "_id": "60547418e1680a3111d00738", "option_value_name": "L", "sort_order": 5, "color_code": ""}
                            ]
                        }],
                        "materialOptions": [{
                            "_id": "601a6a544e966936d4f475e2",
                            "option_name": "Materials",
                            "option_values": [
                                {"status": "1", "_id": "615ecc7ece2599c2b42e9619", "option_value_name": "Cotton", "sort_order": 1},
                                {"status": "1", "_id": "615ecc7ece2599c2b42e961a", "option_value_name": "Rayon", "sort_order": 2},
                                {"status": "1", "_id": "615ecc7ece2599c2b42e961b", "option_value_name": "Net", "sort_order": 3},
                                {"status": "1", "_id": "615ecc7ece2599c2b42e961c", "option_value_name": "Twill", "sort_order": 4},
                                {"status": "1", "_id": "615ecc7ece2599c2b42e961d", "option_value_name": "Neon", "sort_order": 5}
                            ]
                        }],
                        "allCategories": [
                            {"_id": "601a4e5cc63f8b34c1b5f21e", "status": "1", "category_name": "Bottom Wear > Causal Trousers", "parent_id": "601a4c9cc63f8b34c1b5f1fd"},
                            {"_id": "62d6d1c1c62feb75a49e495d", "status": "1", "category_name": "Bottom Wear > Formal Trousers", "parent_id": "601a4c9cc63f8b34c1b5f1fd"},
                            {"_id": "62d6d13ec62feb75a49e495b", "status": "1", "category_name": "Bottom Wear > Jeans", "parent_id": "601a4c9cc63f8b34c1b5f1fd"},
                            {"_id": "62d6d200c62feb75a49e495e", "status": "1", "category_name": "Bottom Wear > Shorts", "parent_id": "601a4c9cc63f8b34c1b5f1fd"},
                            {"_id": "62d6d226c62feb75a49e495f", "status": "1", "category_name": "Bottom Wear > Track Pants & Joggers", "parent_id": "601a4c9cc63f8b34c1b5f1fd"}
                        ]
                    }
                };

                if (sampleData.status) {
                    optionsData = {
                        colors: sampleData.data.colorOptions[0].option_values,
                        sizes: sampleData.data.sizeOptions[0].option_values,
                        materials: sampleData.data.materialOptions[0].option_values,
                        categories: sampleData.data.allCategories
                    };
                    
                    // Sort options by sort_order where applicable
                    optionsData.colors.sort((a, b) => a.sort_order - b.sort_order);
                    optionsData.sizes.sort((a, b) => a.sort_order - b.sort_order);
                    optionsData.materials.sort((a, b) => a.sort_order - b.sort_order);
                    
                    return true;
                } else {
                    console.error('Failed to fetch options data:', sampleData.message);
                    return false;
                }
            } catch (error) {
                console.error('Error fetching options data:', error);
                return false;
            }
        }

        class ProductEditor {
            constructor() {
                this.products = [];
                this.originalProducts = [];
                this.modifiedRows = new Set();
            }

            async init() {
                // Load options data first
                await fetchOptionsData();
                await this.loadProducts();
                this.renderTable();
                this.updateStats();
            }

            async loadProducts() {
                // Check if task_id is provided in URL
                const urlParams = new URLSearchParams(window.location.search);
                const taskId = urlParams.get('task_id');
                
                if (taskId) {
                    await this.loadProductsFromTask(taskId);
                } else {
                    const storedProducts = localStorage.getItem('selectedProducts');
                    if (storedProducts) {
                        this.products = JSON.parse(storedProducts);
                        this.originalProducts = JSON.parse(JSON.stringify(this.products));
                    } else {
                        // Demo data for testing
                        this.products = [
                            {
                                product_name: "Patachio Princess Gown",
                                price: 8999,
                                discounted_price: 0,
                                availability: "in-stock",
                                description: "Introducing our 'Patachio Princess Gown', a captivating blend of elegance and playfulness.",
                                sizes: ["S", "M", "L"],
                                colors: ["Purple", "Lilac"],
                                material: "Satin",
                                categories: ["Dresses", "Women", "Formal"],
                                product_images: [],
                                premium: false
                            },
                            {
                                product_name: "Lilac Princess Purple Ball Gown",
                                price: 10999,
                                discounted_price: 0,
                                availability: "in-stock",
                                description: "Introducing 'Lilac Princess,' a stunning purple ball gown that embodies elegance",
                                sizes: ["M", "L", "XL"],
                                colors: ["Purple", "Lavender"],
                                material: "Chiffon",
                                categories: ["Dresses", "Women", "Formal"],
                                product_images: [],
                                premium: true
                            }
                        ];
                        this.originalProducts = JSON.parse(JSON.stringify(this.products));
                    }
                }
            }

            async loadProductsFromTask(taskId) {
                try {
                    // This would be your actual API call
                    // For demo, we'll use the sample data above
                    const response = { ok: true };
                    const data = { 
                        success: true, 
                        products: this.products,
                        scraper_type: "fashion",
                        is_fixed_version: true
                    };
                    
                    if (response.ok && data.success) {
                        this.products = data.products;
                        this.originalProducts = JSON.parse(JSON.stringify(this.products));
                        
                        // Show task info
                        document.getElementById('currentTaskId').textContent = taskId;
                        const scraperTypeText = data.scraper_type.toUpperCase() + (data.is_fixed_version ? ' (FIXED)' : ' (ORIGINAL)');
                        document.getElementById('scraperType').textContent = scraperTypeText;
                        document.getElementById('taskInfo').style.display = 'block';
                        
                        const versionText = data.is_fixed_version ? 'FIXED version with optimized image URLs' : 'original version';
                        this.showNotification(`Loaded ${data.products.length} products from task ${taskId} (${versionText})`, 'success');
                    } else {
                        throw new Error(data.message || 'Failed to load products from task');
                    }
                } catch (error) {
                    console.error('Error loading products from task:', error);
                    this.showNotification(`Failed to load products from task: ${error.message}`, 'error');
                }
            }

            renderTable() {
                const tbody = document.getElementById('productsTableBody');
                tbody.innerHTML = '';

                this.products.forEach((product, index) => {
                    const row = this.createProductRow(product, index);
                    tbody.appendChild(row);
                });

                // Initialize dropdowns after rendering
                setTimeout(() => {
                    this.initializeDropdowns();
                }, 10);
            }

            createProductRow(product, index) {
                const row = document.createElement('tr');
                row.dataset.index = index;

                const images = product.product_images || [];
                const sizesText = Array.isArray(product.sizes) ? product.sizes.join(', ') : (product.sizes || '');
                const colorsText = Array.isArray(product.colors) ? product.colors.join(', ') : (product.colors || '');
                const categoriesText = Array.isArray(product.metadata?.categories) ? product.metadata.categories.join(', ') : (product.categories ? (Array.isArray(product.categories) ? product.categories.join(', ') : product.categories) : '');
                const availability = product.availability || 'in-stock';
                const allImagesText = images.join('\n');
                
                // Determine if product is premium (price >= 25000)
                const isPremium = (product.price || 0) >= 25000;

                // Create image preview HTML
                const imagePreviewsHTML = images.slice(0, 4).map((img, imgIndex) => {
                    return `
                        <div class="image-wrapper">
                            <img src="${img}" alt="Product ${imgIndex + 1}" class="product-image-preview" 
                                 onclick="productEditor.openImagePreview('${img}')"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDUiIGhlaWdodD0iNDUiIHZpZXdCb3g9IjAgMCA0NSA0NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ1IiBoZWlnaHQ9IjQ1IiBmaWxsPSIjRjFGNUY5Ii8+CjxwYXRoIGQ9Ik0yMi41IDIyLjVDMjIuNSAyMC4wMTQ3IDI0LjUxNDcgMTggMjcgMThDMjkuNDg1MyAxOCAzMS41IDIwLjAxNDcgMzEuNSAyMi41QzMxLjUgMjQuOTg1MyAyOS40ODUzIDI3IDI3IDI3QzI0LjUxNDcgMjcgMjIuNSAyNC45ODUzIDIyLjUgMjIuNVoiIGZpbGw9IiNDQkQ1RTEiLz4KPHBhdGggZD0iTTE4IDI3SDI3TDI1LjUgMjkuMjVIMjAuMjVMMTggMjdaIiBmaWxsPSIjQ0JENUUxIi8+Cjwvc3ZnPgo='">
                            <button class="image-remove-btn" onclick="event.stopPropagation(); productEditor.removeImage(${index}, ${imgIndex})" title="Remove image">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="image-status" title="Availability unknown"></div>
                        </div>
                    `;
                }).join('');

                // Add "Add Image" button if we have space
                const addImageButton = images.length < 4 ? 
                    `<div class="add-image-btn" onclick="productEditor.addImage(${index})" title="Add image URL">
                        <i class="fas fa-plus"></i>
                    </div>` : '';

                const moreImagesIndicator = images.length > 4 ? `<div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 4px; cursor: pointer;" onclick="productEditor.showAllImages(${index})">+${images.length - 4} more</div>` : '';

                const finalImageHTML = imagePreviewsHTML + addImageButton;

                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="row-checkbox" onchange="productEditor.updateStats()">
                    </td>
                    <td class="product-image-cell">
                        <div class="image-container">
                            ${finalImageHTML}
                        </div>
                        ${moreImagesIndicator}
                    </td>
                    <td>
                        <div class="image-sizes-dropdown">
                            <button class="image-sizes-toggle" onclick="toggleImageSizes(this)">
                                <span class="image-sizes-count">${product.image_sizes ? product.image_sizes.length : 0}</span> sizes
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="image-sizes-dropdown-content">
                                ${product.image_sizes && product.image_sizes.length > 0 ? 
                                    product.image_sizes.map(s => `<div class="image-size-item">${s.width}x${s.height}</div>`).join('') : 
                                    '<div class="image-size-item">No size data</div>'
                                }
                            </div>
                        </div>
                    </td>
                    <td>
                        <textarea class="editable-cell name-input" 
                                  onchange="productEditor.markModified(${index})" 
                                  oninput="productEditor.autoResizeTextarea(this)"
                                  placeholder="Product name">${product.product_name || ''}</textarea>
                    </td>
                    <td>
                        <input type="number" class="editable-cell price-input" onchange="productEditor.updatePremiumStatus(${index}); productEditor.markModified(${index})" 
                               placeholder="0.00" step="0.01" value="${product.price || ''}">
                    </td>
                    <td>
                        <input type="number" class="editable-cell price-input" onchange="productEditor.markModified(${index})" 
                               placeholder="0.00" step="0.01" value="${product.discounted_price || ''}" title="Discounted Price (Optional)">
                    </td>
                    <td>
                        <select class="availability-select ${availability}" onchange="productEditor.markModified(${index}); productEditor.updateAvailabilityStyle(this)">
                            <option value="in-stock" ${availability === 'in-stock' ? 'selected' : ''}>In Stock</option>
                            <option value="out-of-stock" ${availability === 'out-of-stock' ? 'selected' : ''}>Out of Stock</option>
                            <option value="limited" ${availability === 'limited' ? 'selected' : ''}>Limited</option>
                            <option value="preorder" ${availability === 'preorder' ? 'selected' : ''}>Pre-order</option>
                        </select>
                    </td>
                    <td>
                        <textarea class="editable-cell description-input" 
                                  onchange="productEditor.markModified(${index})" 
                                  oninput="productEditor.autoResizeTextarea(this)"
                                  placeholder="Product description">${product.description || ''}</textarea>
                    </td>
                    <td>
                        <div class="dropdown-container" data-field="sizes" data-index="${index}">
                            <button type="button" class="dropdown-toggle">
                                <span class="selected-text">Select sizes</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-search">
                                    <input type="text" placeholder="Search sizes..." class="dropdown-search-input">
                                </div>
                                <div class="dropdown-options"></div>
                            </div>
                            <div class="selected-options"></div>
                        </div>
                    </td>
                    <td>
                        <div class="dropdown-container" data-field="colors" data-index="${index}">
                            <button type="button" class="dropdown-toggle">
                                <span class="selected-text">Select colors</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-search">
                                    <input type="text" placeholder="Search colors..." class="dropdown-search-input">
                                </div>
                                <div class="dropdown-options"></div>
                            </div>
                            <div class="selected-options"></div>
                        </div>
                    </td>
                    <td>
                        <div class="dropdown-container" data-field="materials" data-index="${index}">
                            <button type="button" class="dropdown-toggle">
                                <span class="selected-text">Select material</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-search">
                                    <input type="text" placeholder="Search materials..." class="dropdown-search-input">
                                </div>
                                <div class="dropdown-options"></div>
                            </div>
                            <div class="selected-options"></div>
                        </div>
                    </td>
                    <td>
                        <div class="dropdown-container" data-field="categories" data-index="${index}">
                            <button type="button" class="dropdown-toggle">
                                <span class="selected-text">Select categories</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-search">
                                    <input type="text" placeholder="Search categories..." class="dropdown-search-input">
                                </div>
                                <div class="dropdown-options"></div>
                            </div>
                            <div class="selected-options"></div>
                        </div>
                    </td>
                    <td>
                        <div class="row-actions">
                            <button class="row-btn view tooltip" onclick="productEditor.openProductUrl(${index})" data-tooltip="View source product page" ${!(product.url || product.source_url) ? 'disabled' : ''}>
                                <i class="fas fa-external-link-alt"></i>
                            </button>
                            <button class="row-btn duplicate tooltip" onclick="productEditor.duplicateRow(${index})" data-tooltip="Duplicate this product">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="row-btn delete tooltip" onclick="productEditor.deleteRow(${index})" data-tooltip="Delete this product">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <label class="premium-toggle">
                            <input type="checkbox" ${isPremium ? 'checked' : ''} onchange="productEditor.markModified(${index})">
                            <span class="toggle-slider"></span>
                        </label>
                    </td>
                `;

                return row;
            }

            initializeDropdowns() {
                const dropdownContainers = document.querySelectorAll('.dropdown-container');
                
                dropdownContainers.forEach(container => {
                    const field = container.getAttribute('data-field');
                    const index = parseInt(container.getAttribute('data-index'));
                    const product = this.products[index];
                    
                    // Get current values
                    let currentValues = [];
                    if (field === 'sizes') {
                        currentValues = Array.isArray(product.sizes) ? product.sizes : (product.sizes ? [product.sizes] : []);
                    } else if (field === 'colors') {
                        currentValues = Array.isArray(product.colors) ? product.colors : (product.colors ? [product.colors] : []);
                    } else if (field === 'materials') {
                        currentValues = product.material ? [product.material] : [];
                    } else if (field === 'categories') {
                        currentValues = Array.isArray(product.categories) ? product.categories : (product.categories ? [product.categories] : []);
                    }
                    
                    this.setupDropdown(container, field, index, currentValues);
                });
            }

            setupDropdown(container, field, index, currentValues) {
                const toggle = container.querySelector('.dropdown-toggle');
                const menu = container.querySelector('.dropdown-menu');
                const optionsContainer = container.querySelector('.dropdown-options');
                const searchInput = container.querySelector('.dropdown-search-input');
                const selectedOptionsContainer = container.querySelector('.selected-options');
                
                // Add specific class for material dropdown
                if (field === 'materials') {
                    container.classList.add('material-dropdown');
                }
                
                // Set current values
                currentValues.forEach(value => {
                    this.addSelectedTag(field, value, index, selectedOptionsContainer);
                });
                
                // Update toggle text
                this.updateToggleText(toggle, selectedOptionsContainer, field !== 'materials');
                
                // Toggle dropdown
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = menu.classList.contains('show');
                    
                    // Close all other dropdowns first
                    document.querySelectorAll('.dropdown-menu').forEach(d => {
                        d.classList.remove('show');
                    });
                    
                    if (!isOpen) {
                        menu.classList.add('show');
                        this.renderDropdownOptions(field, optionsContainer, '', selectedOptionsContainer, index);
                        searchInput.focus();
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!container.contains(e.target)) {
                        menu.classList.remove('show');
                    }
                });
                
                // Filter options based on search
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    this.renderDropdownOptions(field, optionsContainer, searchTerm, selectedOptionsContainer, index);
                });
                
                // Prevent click inside dropdown from closing it
                menu.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            renderDropdownOptions(field, container, searchTerm, selectedContainer, index) {
                const options = optionsData[field] || [];
                container.innerHTML = '';
                
                const filteredOptions = options.filter(option => {
                    const name = field === 'categories' ? option.category_name : option.option_value_name;
                    return name.toLowerCase().includes(searchTerm);
                });
                
                if (filteredOptions.length === 0) {
                    container.innerHTML = '<div class="dropdown-item">No options found</div>';
                    return;
                }
                
                filteredOptions.forEach(option => {
                    const name = field === 'categories' ? option.category_name : option.option_value_name;
                    const optionElement = document.createElement('div');
                    optionElement.className = 'dropdown-item';
                    
                    // Add title attribute for tooltip on hover
                    optionElement.title = name;
                    
                    if (field === 'colors') {
                        optionElement.innerHTML = `
                            <div class="color-option">
                                <div class="color-box" style="background-color: ${option.color_code || '#ccc'}"></div>
                                <span class="truncated-text" data-fulltext="${name}">${name}</span>
                            </div>
                        `;
                    } else {
                        optionElement.innerHTML = `<span class="truncated-text" data-fulltext="${name}">${name}</span>`;
                    }
                    
                    optionElement.addEventListener('click', () => {
                        this.selectOption(field, name, index, selectedContainer, field !== 'materials');
                        container.parentElement.classList.remove('show');
                    });
                    
                    container.appendChild(optionElement);
                });
            }

            selectOption(field, value, index, selectedContainer, multiple) {
                const currentValues = this.getCurrentValues(field, index);
                
                if (multiple) {
                    // For multi-select fields (sizes, colors, categories)
                    if (!currentValues.includes(value)) {
                        currentValues.push(value);
                        this.addSelectedTag(field, value, index, selectedContainer);
                    }
                } else {
                    // For single-select fields (materials)
                    selectedContainer.innerHTML = '';
                    this.addSelectedTag(field, value, index, selectedContainer);
                    currentValues.length = 0;
                    currentValues.push(value);
                }
                
                // Update product data
                this.updateProductValue(field, currentValues, index);
                
                // Update toggle text
                const toggle = selectedContainer.closest('.dropdown-container').querySelector('.dropdown-toggle');
                this.updateToggleText(toggle, selectedContainer, multiple);
            }

            addSelectedTag(field, value, index, selectedContainer) {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
                tag.innerHTML = `
                    <span>${value}</span>
                    <span class="remove" onclick="productEditor.removeSelectedOption('${field}', '${value}', ${index}, this.parentElement.parentElement)"></span>
                `;
                selectedContainer.appendChild(tag);
            }
            
            removeSelectedOption(field, value, index, selectedContainer) {
                const currentValues = this.getCurrentValues(field, index);
                const newValues = currentValues.filter(v => v !== value);
                
                // Update UI
                selectedContainer.innerHTML = '';
                newValues.forEach(v => this.addSelectedTag(field, v, index, selectedContainer));
                
                // Update product data
                this.updateProductValue(field, newValues, index);
                
                // Update toggle text
                const toggle = selectedContainer.closest('.dropdown-container').querySelector('.dropdown-toggle');
                this.updateToggleText(toggle, selectedContainer, field !== 'materials');
            }

            updateToggleText(toggle, selectedContainer, multiple) {
                const selectedCount = selectedContainer.querySelectorAll('.selected-tag').length;
                if (multiple) {
                    toggle.querySelector('.selected-text').textContent = selectedCount > 0 ? `${selectedCount} selected` : 'Select options';
                } else {
                    const selectedTag = selectedContainer.querySelector('.selected-tag');
                    toggle.querySelector('.selected-text').textContent = selectedTag ? selectedTag.textContent.replace('', '') : 'Select option';
                }
            }

            getCurrentValues(field, index) {
                const product = this.products[index];
                let currentValues = [];
                
                switch (field) {
                    case 'sizes':
                        currentValues = Array.isArray(product.sizes) ? [...product.sizes] : (product.sizes ? [product.sizes] : []);
                        break;
                    case 'colors':
                        currentValues = Array.isArray(product.colors) ? [...product.colors] : (product.colors ? [product.colors] : []);
                        break;
                    case 'materials':
                        currentValues = product.material ? [product.material] : [];
                        break;
                    case 'categories':
                        currentValues = Array.isArray(product.categories) ? [...product.categories] : (product.categories ? [product.categories] : []);
                        break;
                }
                
                return currentValues;
            }

            updateProductValue(field, value, index) {
                const product = this.products[index];
                
                switch (field) {
                    case 'sizes':
                        product.sizes = value;
                        break;
                    case 'colors':
                        product.colors = value;
                        break;
                    case 'materials':
                        product.material = value.length > 0 ? value[0] : '';
                        break;
                    case 'categories':
                        product.categories = value;
                        break;
                }
                
                // Mark the product as modified
                this.markModified(index);
            }

            updatePremiumStatus(index) {
                const priceInput = document.querySelector(`tr[data-index="${index}"] .price-input`);
                const premiumToggle = document.querySelector(`tr[data-index="${index}"] .premium-toggle input`);
                
                if (priceInput && premiumToggle) {
                    const price = parseFloat(priceInput.value) || 0;
                    premiumToggle.checked = price >= 25000;
                }
                
                this.updateStats();
            }

            markModified(index) {
                this.modifiedRows.add(index);
                const row = document.querySelector(`tr[data-index="${index}"]`);
                if (row) {
                    row.querySelectorAll('.editable-cell, .availability-select').forEach(cell => {
                        cell.classList.add('modified');
                    });
                    
                    // Add subtle animation to indicate change
                    row.style.background = 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';
                    setTimeout(() => {
                        row.style.background = '';
                    }, 1000);
                }
                this.updateStats();
            }

            updateAvailabilityStyle(selectElement) {
                const value = selectElement.value;
                selectElement.className = `availability-select ${value}`;
            }

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            checkImageAvailability(imageUrl) {
                // Simple check - in real app, you might want to check if image actually loads
                return imageUrl && imageUrl.trim() !== '';
            }

            openImagePreview(imageUrl) {
                if (imageUrl) {
                    window.open(imageUrl, '_blank');
                }
            }

            openProductUrl(index) {
                const product = this.products[index];
                const productUrl = product?.source_url || product?.url;
                if (product && productUrl) {
                    window.open(productUrl, '_blank');
                    this.showNotification('Opening product page...', 'success');
                } else {
                    this.showNotification('No product URL available', 'error');
                }
            }

            removeImage(productIndex, imageIndex) {
                if (confirm('Are you sure you want to remove this image?')) {
                    this.products[productIndex].product_images.splice(imageIndex, 1);
                    this.markModified(productIndex);
                    this.renderTable();
                    this.showNotification('Image removed successfully!', 'success');
                }
            }

            addImage(productIndex) {
                const imageUrl = prompt('Enter image URL:');
                if (imageUrl && imageUrl.trim()) {
                    const trimmedUrl = imageUrl.trim();
                    if (this.isValidImageUrl(trimmedUrl)) {
                        this.products[productIndex].product_images.push(trimmedUrl);
                        this.markModified(productIndex);
                        this.renderTable();
                        this.showNotification('Image added successfully!', 'success');
                    } else {
                        this.showNotification('Please enter a valid image URL', 'error');
                    }
                }
            }

            isValidImageUrl(url) {
                try {
                    new URL(url);
                    return /\.(jpg|jpeg|png|gif|bmp|webp|svg)(\?.*)?$/i.test(url) || 
                           url.includes('cdn.shop') || url.includes('shopify');
                } catch {
                    return false;
                }
            }

            showAllImages(productIndex) {
                const product = this.products[productIndex];
                const images = product.product_images || [];
                
                if (images.length === 0) {
                    this.showNotification('No images available', 'error');
                    return;
                }

                const modal = document.createElement('div');
                modal.className = 'loading-overlay';
                modal.innerHTML = `
                    <div class="loading-content" style="max-width: 80%; max-height: 80%; overflow-y: auto; text-align: left;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: white; z-index: 1;">
                            <h3 style="margin: 0; color: var(--text-primary);">
                                <i class="fas fa-images" style="margin-right: 8px; color: var(--accent-purple);"></i>
                                All Images for: ${product.product_name || 'Product'}
                            </h3>
                            <button onclick="document.body.removeChild(this.closest('.loading-overlay'))" 
                                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
                            ${images.map((img, imgIndex) => `
                                <div style="position: relative; border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden;">
                                    <img src="${img}" style="width: 100%; height: 120px; object-fit: cover;" 
                                         onclick="window.open('${img}', '_blank')"
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ0iIxMjAiIHZpZXdCb3g9IjAgMCAxNTAgMTIwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgZmlsbD0iI0YxRjVGOSIvPgo8dGV4dCB4PSI3NSIgeT0iNjUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNDQkQ1RTEiIGZvbnQtc2l6ZT0iMTIiPkltYWdlIEVycm9yPC90ZXh0Pgo8L3N2Zz4K'">
                                    <div style="position: absolute; top: 4px; right: 4px;">
                                        <button onclick="productEditor.removeImageFromModal(${productIndex}, ${imgIndex}); document.body.removeChild(this.closest('.loading-overlay')); productEditor.renderTable();" 
                                                style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div style="padding: 8px; background: white; border-top: 1px solid var(--border-light); font-size: 0.8rem; color: var(--text-secondary);">
                                        Image ${imgIndex + 1}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            removeImageFromModal(productIndex, imageIndex) {
                this.products[productIndex].product_images.splice(imageIndex, 1);
                this.markModified(productIndex);
                this.showNotification('Image removed successfully!', 'success');
            }

            duplicateRow(index) {
                const productToDuplicate = { ...this.products[index] };
                productToDuplicate.product_name = (productToDuplicate.product_name || '') + ' (Copy)';
                
                this.products.push(productToDuplicate);
                this.renderTable();
                this.updateStats();
                this.showNotification('Product duplicated successfully!', 'success');
            }

            deleteRow(index) {
                if (confirm('Are you sure you want to delete this product?')) {
                    this.products.splice(index, 1);
                    this.modifiedRows.delete(index);
                    this.renderTable();
                    this.updateStats();
                    this.showNotification('Product deleted successfully!', 'success');
                }
            }

            updateStats() {
                const totalProducts = this.products.length;
                const modifiedProducts = this.modifiedRows.size;
                const selectedProducts = document.querySelectorAll('.row-checkbox:checked').length;
                
                // Count premium products
                const premiumProducts = document.querySelectorAll('.premium-toggle input:checked').length;

                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('modifiedProducts').textContent = modifiedProducts;
                document.getElementById('selectedProducts').textContent = selectedProducts;
                document.getElementById('premiumProducts').textContent = premiumProducts;
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i> ${message}`;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.classList.add('show'), 100);
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => document.body.removeChild(notification), 300);
                }, 3000);
            }

            collectProductData() {
                const rows = document.querySelectorAll('#productsTableBody tr');
                const products = [];

                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('.editable-cell');
                    const availabilitySelect = row.querySelector('.availability-select');
                    const premiumToggle = row.querySelector('.premium-toggle input');
                    
                    const product = {
                        product_name: cells[0].value.trim(),
                        price: parseFloat(cells[1].value) || 0,
                        discounted_price: parseFloat(cells[2].value) || 0,
                        premium: premiumToggle.checked,
                        availability: availabilitySelect.value,
                        description: cells[3].value.trim(),
                        sizes: this.getCurrentValues('sizes', index),
                        colors: this.getCurrentValues('colors', index),
                        material: this.getCurrentValues('materials', index)[0] || '',
                        categories: this.getCurrentValues('categories', index),
                        product_images: this.products[index].product_images || [],
                        url: this.products[index].url || '',
                        source_url: this.products[index].source_url || '',
                        timestamp: new Date().toISOString(),
                        extraction_method: 'manual_edit'
                    };
                    products.push(product);
                });

                return products;
            }
        }

        // Toggle image sizes dropdown
        function toggleImageSizes(button) {
            const dropdown = button.nextElementSibling;
            const isOpen = dropdown.classList.contains('show');
            
            // Close all open dropdowns first
            document.querySelectorAll('.image-sizes-dropdown-content').forEach(content => {
                content.classList.remove('show');
            });
            
            document.querySelectorAll('.image-sizes-toggle').forEach(toggle => {
                toggle.classList.remove('open');
            });
            
            // Toggle this dropdown if it wasn't open
            if (!isOpen) {
                dropdown.classList.add('show');
                button.classList.add('open');
            }
            
            // Stop propagation to prevent immediate document click
            event.stopPropagation();
        }

        // Close dropdowns when clicking elsewhere
        document.addEventListener('click', function() {
            document.querySelectorAll('.image-sizes-dropdown-content').forEach(content => {
                content.classList.remove('show');
            });
            
            document.querySelectorAll('.image-sizes-toggle').forEach(toggle => {
                toggle.classList.remove('open');
            });
            
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        });

        // Global functions
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            productEditor.updateStats();
        }

        function selectAllRows() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleSelectAll();
        }

        function deleteSelectedRows() {
            const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Please select products to delete.');
                return;
            }

            if (confirm(`Are you sure you want to delete ${selectedCheckboxes.length} selected products?`)) {
                const indicesToDelete = Array.from(selectedCheckboxes)
                    .map(checkbox => parseInt(checkbox.closest('tr').dataset.index))
                    .sort((a, b) => b - a); // Sort in descending order

                indicesToDelete.forEach(index => {
                    productEditor.products.splice(index, 1);
                    productEditor.modifiedRows.delete(index);
                });

                productEditor.renderTable();
                productEditor.updateStats();
                productEditor.showNotification(`${indicesToDelete.length} products deleted successfully!`, 'success');
            }
        }

        function addNewProduct() {
            const newProduct = {
                product_name: 'New Product',
                price: 0,
                discounted_price: 0,
                premium: false,
                availability: 'in-stock',
                description: '',
                sizes: [],
                colors: [],
                material: '',
                categories: [],
                product_images: [],
                url: '',
                timestamp: new Date().toISOString(),
                extraction_method: 'manual_add'
            };

            productEditor.products.push(newProduct);
            productEditor.renderTable();
            productEditor.updateStats();
            productEditor.showNotification('New product added!', 'success');
        }

        function resetChanges() {
            if (confirm('Are you sure you want to reset all changes? This will restore the original data.')) {
                productEditor.products = JSON.parse(JSON.stringify(productEditor.originalProducts));
                productEditor.modifiedRows.clear();
                productEditor.renderTable();
                productEditor.updateStats();
                productEditor.showNotification('Changes reset successfully!', 'success');
            }
        }

        function saveChanges() {
            const updatedProducts = productEditor.collectProductData();
            localStorage.setItem('selectedProducts', JSON.stringify(updatedProducts));
            productEditor.modifiedRows.clear();
            productEditor.renderTable();
            productEditor.updateStats();
            productEditor.showNotification('Changes saved successfully!', 'success');
        }

        function exportData() {
            const products = productEditor.collectProductData();
            const csvContent = convertToCSV(products);
            downloadCSV(csvContent, 'products.csv');
            productEditor.showNotification('CSV exported successfully!', 'success');
        }

        function convertToCSV(products) {
            if (products.length === 0) return '';

            const headers = ['Product Name', 'Price', 'Discounted Price', 'Premium', 'Availability', 'Description', 'Sizes', 'Colors', 'Material', 'Categories', 'Image URLs'];
            const csvRows = [headers.join(',')];

            products.forEach(product => {
                const row = [
                    `"${product.product_name || ''}"`,
                    product.price || 0,
                    product.discounted_price || 0,
                    product.premium ? 'Yes' : 'No',
                    `"${product.availability || 'in-stock'}"`,
                    `"${product.description || ''}"`,
                    `"${Array.isArray(product.sizes) ? product.sizes.join(', ') : ''}"`,
                    `"${Array.isArray(product.colors) ? product.colors.join(', ') : ''}"`,
                    `"${product.material || ''}"`,
                    `"${Array.isArray(product.categories) ? product.categories.join(', ') : ''}"`,
                    `"${Array.isArray(product.product_images) ? product.product_images.join(' | ') : ''}"`
                ];
                csvRows.push(row.join(','));
            });

            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

         async function uploadProducts() {
            const products = productEditor.collectProductData();
            
            if (products.length === 0) {
                alert('No products to upload.');
                return;
            }

            if (!confirm(`Are you sure you want to upload ${products.length} products?`)) {
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            try {
                // First, fetch the options data from the API
                const optionsData = await fetchOptionsDataFromAPI();
                
                // Enhance products with API data for sizes, colors, materials, and categories
                const enhancedProducts = products.map(product => {
                    return {
                        ...product,
                        // Override with API data
                        sizes: optionsData.sizes,
                        colors: optionsData.colors,
                        material: optionsData.materials.length > 0 ? optionsData.materials[0] : '',
                        categories: optionsData.categories
                    };
                });

                // Prepare the upload data
                const uploadData = {
                    products: enhancedProducts,
                    metadata: {
                        timestamp: new Date().toISOString(),
                        total_products: enhancedProducts.length,
                        upload_type: "manual_edit",
                        source: "edit_interface",
                        options_data: optionsData
                    }
                };

                // Send to the backend API
                const response = await fetch('/api/upload-products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(uploadData)
                });

                const result = await response.json();

                if (result.success) {
                    productEditor.showNotification(`Successfully uploaded ${enhancedProducts.length} products!`, 'success');
                    
                    // Clear localStorage after successful upload
                    localStorage.removeItem('selectedProducts');
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                productEditor.showNotification(`Upload failed: ${error.message}`, 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Function to fetch options data from the API
        async function fetchOptionsDataFromAPI() {
            try {
                const response = await fetch('https://www.zotik.in/api/option/all-options');
                const data = await response.json();
                
                if (data.status) {
                    // Extract and format the options data
                    const colorOptions = data.data.colorOptions[0].option_values;
                    const sizeOptions = data.data.sizeOptions[0].option_values;
                    const materialOptions = data.data.materialOptions[0].option_values;
                    const categories = data.data.allCategories;
                    
                    return {
                        colors: colorOptions.map(opt => opt.option_value_name),
                        sizes: sizeOptions.map(opt => opt.option_value_name),
                        materials: materialOptions.map(opt => opt.option_value_name),
                        categories: categories.map(cat => cat.category_name)
                    };
                } else {
                    throw new Error(data.message || 'Failed to fetch options data');
                }
            } catch (error) {
                console.error('Error fetching options data:', error);
                // Return fallback data if API fails
                return {
                    colors: ['Red', 'Blue', 'Green', 'Black', 'White'],
                    sizes: ['S', 'M', 'L', 'XL', 'XXL'],
                    materials: ['Cotton', 'Polyester', 'Silk', 'Wool'],
                    categories: ['Clothing', 'Accessories', 'Footwear']
                };
            }
        }
        
        function toggleKeyboardHelp() {
            const modal = document.getElementById('keyboardHelpModal');
            modal.style.display = modal.style.display === 'none' ? 'flex' : 'none';
        }


        
        // Initialize the editor
        let productEditor;
        document.addEventListener('DOMContentLoaded', async () => {
            productEditor = new ProductEditor();
            await productEditor.init();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveChanges();
                    productEditor.showNotification('Changes saved with Ctrl+S!', 'success');
                }
                
                // Ctrl/Cmd + E to export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportData();
                    productEditor.showNotification('Data exported with Ctrl+E!', 'success');
                }
                
                // Escape to clear focus
                if (e.key === 'Escape') {
                    document.activeElement.blur();
                }
            });
            
            // Auto-save every 30 seconds
            setInterval(() => {
                if (productEditor.modifiedRows.size > 0) {
                    saveChanges();
                    productEditor.showNotification('Auto-saved changes', 'success');
                }
            }, 30000);
        });
    </script>
</body>
</html>
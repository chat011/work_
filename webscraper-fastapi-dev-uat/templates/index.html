<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Fashion Scraper - Professional E-commerce Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
            --secondary-gradient: linear-gradient(135deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
            --dark-bg: #0a0a0f;
            --card-bg: rgba(255, 255, 255, 0.98);
            --card-bg-dark: rgba(15, 15, 35, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-bg-strong: rgba(255, 255, 255, 0.12);
            --text-primary: #1e1e2e;
            --text-primary-dark: rgba(255, 255, 255, 0.95);
            --text-secondary: #6b7280;
            --text-secondary-dark: rgba(255, 255, 255, 0.75);
            --text-muted: rgba(255, 255, 255, 0.6);
            --accent-blue: #2563eb;
            --accent-purple: #7c3aed;
            --accent-pink: #db2777;
            --accent-cyan: #0891b2;
            --success-green: #059669;
            --warning-orange: #d97706;
            --error-red: #dc2626;
            --border-light: rgba(255, 255, 255, 0.15);
            --border-strong: rgba(255, 255, 255, 0.25);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 35px 60px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 30px rgba(139, 92, 246, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--dark-bg);
            background-image:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            /* min-height: 100vh; */
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 2;
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .floating-elements::before,
        .floating-elements::after {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: var(--primary-gradient);
            opacity: 0.1;
            animation: float 20s infinite ease-in-out;
        }

        .floating-elements::before {
            top: 10%;
            right: 10%;
            animation-delay: -5s;
        }

        .floating-elements::after {
            bottom: 10%;
            left: 10%;
            animation-delay: -10s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            33% {
                transform: translateY(-30px) rotate(120deg);
            }

            66% {
                transform: translateY(30px) rotate(240deg);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
            text-shadow: none;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 16px;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 12px;
        }

        .header-badge i {
            color: var(--accent-purple);
        }

        .chat-container {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 600px;
            backdrop-filter: blur(20px);
            position: relative;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            pointer-events: none;
            z-index: 1;
        }

        .chat-header {
            background: var(--primary-gradient);
            color: white;
            padding: 16px 20px;
            text-align: center;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .chat-header h2 {
            font-size: 1.3rem;
            margin-bottom: 4px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .chat-header p {
            opacity: 0.95;
            font-size: 0.85rem;
            font-weight: 400;
        }

        .settings-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 20px;
            position: relative;
            z-index: 2;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: center;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .setting-item label {
            font-weight: 500;
            color: #374151;
            font-size: 0.9rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background: var(--primary-gradient);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.3);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
            box-shadow: var(--shadow-sm);
        }

        .slider:hover {
            box-shadow: var(--shadow-sm);
        }

        .number-input {
            width: 90px;
            padding: 10px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
            text-align: center;
            font-weight: 600;
            background: white;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .number-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            transform: translateY(-1px);
        }

        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #fafafa;
        }

        .input-section {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .url-input-container {
            position: relative;
            margin-bottom: 12px;
        }

        .url-input {
            width: 100%;
            min-height: 100px;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.95rem;
            resize: vertical;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            line-height: 1.5;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1), var(--shadow-md);
            transform: translateY(-2px);
        }

        .url-input::placeholder {
            color: #9ca3af;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-md);
            font-weight: 600;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow), var(--shadow-lg);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            border: 2px solid #e2e8f0;
            font-weight: 600;
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pulse-animation {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(220, 38, 38, 0.5);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
                transform: scale(1.02);
            }
        }

        #activeTasksBtn {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #dc2626;
            border: 2px solid #fca5a5;
            font-weight: 600;
            position: relative;
        }

        #activeTasksBtn:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border-color: #dc2626;
        }

        #clearBtn {
            transition: all 0.3s ease;
        }

        #clearBtn:hover {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #dc2626;
            border-color: #fca5a5;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff40;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .message {
            margin-bottom: 12px;
            padding: 14px;
            border-radius: 12px;
            max-width: 90%;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            position: relative;
        }

        .message:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .message.user {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message.system {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            color: var(--text-primary);
            font-weight: 500;
        }

        .message.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border: 2px solid #fca5a5;
            color: var(--error-red);
            font-weight: 600;
        }

        .message.success {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
            color: var(--success-green);
            font-weight: 600;
        }

        .progress-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .progress-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-title i {
            color: var(--accent-purple);
            font-size: 1.2rem;
        }

        .progress-stats {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--success-green);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .connection-icon {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .progress-bar-container {
            position: relative;
            margin: 16px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 6px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0%;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-glow {
            position: absolute;
            top: -2px;
            left: 0;
            right: 0;
            height: 16px;
            background: var(--primary-gradient);
            border-radius: 8px;
            opacity: 0.3;
            filter: blur(8px);
            z-index: -1;
        }

        .progress-details {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-top: 12px;
            font-weight: 500;
        }

        .progress-details i {
            color: var(--accent-blue);
        }

        .detailed-progress {
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px;
            max-height: 180px;
            overflow-y: auto;
        }

        .progress-log {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .log-entry {
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            border-left: 3px solid var(--accent-blue);
            animation: slideInLog 0.3s ease-out;
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .log-entry.success {
            border-left-color: var(--success-green);
            background: rgba(34, 197, 94, 0.1);
        }

        .log-entry.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .log-entry.ai-analysis {
            border-left-color: var(--accent-purple);
            background: rgba(147, 51, 234, 0.1);
        }

        .log-entry.extraction {
            border-left-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .log-entry .timestamp {
            color: var(--text-muted);
            font-size: 0.8rem;
            opacity: 0.7;
        }

        @keyframes slideInLog {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .detailed-progress::-webkit-scrollbar {
            width: 4px;
        }

        .detailed-progress::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .detailed-progress::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 2px;
        }

        .task-started-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .task-started-compact .status-icon {
            font-size: 1.1rem;
        }

        .task-started-compact .status-text {
            font-weight: 600;
            color: var(--success-green);
        }

        .task-id-container {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
        }

        .task-id-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        .task-id-code {
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-blue);
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .task-id-code:hover {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        .task-id-code.copied {
            background: rgba(34, 197, 94, 0.15);
            border-color: rgba(34, 197, 94, 0.5);
            color: var(--success-green);
        }

        .task-id-code.copied::after {
            content: " ‚úì Copied!";
            font-size: 0.7rem;
            opacity: 0.8;
        }

        .scraping-session-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 20px;
            margin: 10px 0;
        }

        .session-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .session-header i {
            color: var(--accent-purple);
            font-size: 1.3rem;
        }

        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .detail-item i {
            color: var(--accent-blue);
            width: 16px;
            text-align: center;
        }

        .chat-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 700px;
            border: 1px solid var(--border-light);
        }

        .chat-header {
            background: var(--primary-gradient);
            color: white;
            padding: 24px;
            text-align: center;
            position: relative;
        }

        .chat-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .chat-header h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }

        .settings-panel {
            background: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            padding: 24px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .product-card.selected {
            border-color: var(--accent-purple);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .product-select-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }

        .product-checkbox {
            display: none;
        }

        .product-select-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .product-select-label:hover {
            background: rgba(255, 255, 255, 1);
            border-color: var(--accent-purple);
            transform: scale(1.05);
        }

        .product-checkbox:checked+.product-select-label {
            background: var(--accent-purple);
            border-color: var(--accent-purple);
            color: white;
        }

        .product-checkbox:checked+.product-select-label i {
            transform: scale(1.2);
        }

        .products-header {
            margin-bottom: 20px;
        }

        .products-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f1f5f9;
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
            font-size: 1rem;
            line-height: 1.4;
        }

        .product-price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #059669;
            margin-bottom: 10px;
        }

        .product-details {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .product-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            margin: 16px;
            border: 2px dashed #cbd5e1;
            position: relative;
            overflow: hidden;
        }

        .empty-state::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(139, 92, 246, 0.05) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .empty-state h3 {
            font-size: 1.8rem;
            margin-bottom: 16px;
            color: #1e293b;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
            line-height: 1.6;
        }

        .empty-state p:last-child {
            font-weight: 600;
            color: var(--accent-purple);
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }

            .header {
                margin-bottom: 16px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 4px;
            }

            .header p {
                font-size: 0.9rem;
                margin-bottom: 12px;
            }

            .header-badge {
                padding: 4px 8px;
                font-size: 0.7rem;
                margin-bottom: 8px;
            }

            .chat-container {
                min-height: 500px;
                border-radius: 16px;
            }

            .chat-header {
                padding: 12px 16px;
            }

            .chat-header h2 {
                font-size: 1.1rem;
                margin-bottom: 2px;
            }

            .chat-header p {
                font-size: 0.8rem;
            }

            .settings-panel {
                padding: 12px 16px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .setting-item label {
                font-size: 0.85rem;
            }

            .chat-messages {
                padding: 12px;
            }

            .input-section {
                padding: 12px 16px;
            }

            .url-input {
                min-height: 80px;
                padding: 12px;
                font-size: 0.9rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
                justify-content: center;
            }

            .message {
                padding: 12px;
                max-width: 95%;
                margin-bottom: 10px;
            }

            .progress-container {
                padding: 12px;
                margin: 8px 0;
            }

            .progress-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                margin-bottom: 10px;
            }

            .progress-stats {
                gap: 12px;
            }

            .progress-title {
                font-size: 1rem;
            }

            .progress-percentage {
                font-size: 1.3rem;
            }

            .products-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .empty-state {
                padding: 40px 20px;
                margin: 12px;
            }

            .empty-state h3 {
                font-size: 1.4rem;
            }

            .empty-state p {
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .chat-container {
                min-height: 450px;
            }

            .url-input {
                min-height: 70px;
                padding: 10px;
            }

            .message {
                padding: 10px;
            }

            .progress-container {
                padding: 10px;
            }
        }

        /* :root{--gap:12px;--card-bg:#fff;--muted:#666}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;line-height:1.4;background:#f6f7fb;padding:24px;color:#111} */
        /* .container{max-width:980px;margin:0 auto;background:transparent} */
        .card {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(25, 25, 40, .06)
        }

        h1 {
            font-size: 20px;
            margin: 0 0 12px
        }

        .list {
            margin-top: 12px;
            border-radius: 8px;
            overflow: hidden
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px solid #efefef;
            background: #fff
        }

        .row:nth-child(odd) {
            background: #fbfbfd
        }

        .url {
            flex: 1;
            word-break: break-all;
            padding-right: 12px
        }

        .actions {
            flex: 0 0 160px;
            display: flex;
            gap: 8px;
            justify-content: flex-end
        }

        button {
            appearance: none;
            border: 0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600
        }

        .grab {
            background: #0b6efd;
            color: #fff
        }

        .copy {
            background: #eef2ff;
            color: #0b6efd
        }

        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin-top: 14px
        }

        .pagination button {
            background: #f1f1f1;
            border: 1px solid #ccc;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .pagination button:hover {
            background: #e6e6e6;
        }

        .pagination button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
            transform: scale(1.05);
        }

        .page-btn {
            min-width: 44px;
            padding: 8px 10px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #e6e9ef;
            cursor: pointer
        }

        .page-btn.active {
            background: #0b6efd;
            color: #fff;
            border-color: #0b6efd
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-top: 14px
        }

        .perpage {
            color: var(--muted);
            font-size: 13px
        }

        @media (max-width:600px) {
            .actions {
                flex: 0 0 120px
            }

            .url {
                font-size: 13px
            }
        }

        .url-row {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            border-radius: 6px;
            margin-bottom: 6px;
            transition: background 0.2s;
        }

        .url-row:hover {
            background: #f0f8ff;
        }

        .url-btn {
            background: #007bff;
            border: none;
            color: white;
            padding: 6px 10px;
            margin-right: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .url-btn:hover {
            background: #0056b3;
        }

        .url-text {
            font-family: monospace;
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="noise-overlay"></div>
    <div class="floating-elements"></div>

    <div class="container">
        <div class="header">
            <div class="header-badge">
                <i class="fas fa-sparkles"></i>
                <span>Powered by Gemini AI</span>
            </div>
            <h1>AI Fashion Scraper</h1>
            <p>Professional E-commerce Intelligence Platform</p>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <h2>Fashion Product Scraper</h2>
                <p>Enter e-commerce URLs to extract product data with AI intelligence</p>
            </div>

            <div class="settings-panel">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="maxPages">Max Pages per URL:</label>
                        <input type="number" id="maxPages" class="number-input" value="50" min="1" max="100">
                    </div>
                    <div class="setting-item">
                        <label for="aiPagination">AI Pagination:</label>
                        <label class="switch">
                            <input type="checkbox" id="aiPagination" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <label for="aiExtraction">AI Extraction Mode:</label>
                        <label class="switch">
                            <input type="checkbox" id="aiExtraction" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div>
                <div class="settings-panel">
                    <input id="showDomain" name="choice" type="radio" value="domain" /> Domain Extraction &nbsp;&nbsp;
                    <input id="showProducts" name="choice" type="radio" value="product" /> Product Extraction
                </div>

                <div id="inputSectionurl">
                    <div class="input-section">
                        <div class="url-input-container">
                            <textarea id="domainurlInput" class="url-input"
                                placeholder="Enter e-commerce URLs (one per line)&#10;&#10;Examples:&#10;https://deashaindia.com/collections/sarees&#10;https://example-store.com/products/dress&#10;https://shop.example.com/category/accessories"></textarea>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-secondary" id="clearBtn">
                                üóëÔ∏è Clear
                            </button>
                            <button class="btn btn-secondary" id="activeTasksBtn" style="display: none;">
                                <span id="activeTasksCount">0</span> Active Tasks
                            </button>
                            <button class="btn btn-primary" id="scrapeDomain">
                                üöÄ Grab SubDomain
                            </button>
                        </div>
                    </div>

                    <div class="container">
                        <div class="card">
                            <h1>Product URL List</h1>
                            <div class="controls">
                                <div class="perpage">Showing <span id="range">1 - 10</span> of <strong
                                        id="total"></strong>
                                    URLs
                                </div>
                                <div>
                                    <label for="perPage">Per page: </label>
                                    <select id="perPageSelect">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                    </select>
                                </div>
                            </div>


                            <div class="list" id="domainList"></div>


                            <div class="pagination" id="pagination"></div>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <h3>Ready to Scrape Fashion Products</h3>
                        <p>Enter one or more e-commerce URLs below to start extracting product data with AI
                            intelligence.
                        </p>
                        <p><strong>Supported:</strong> Shopify, WooCommerce, and custom e-commerce sites</p>
                    </div>
                </div>


                <div class="input-section" id="inputSectionScrape">
                    <div class="url-input-container">
                        <textarea id="urlInput" class="url-input"
                            placeholder="Enter e-commerce URLs (one per line)&#10;&#10;Examples:&#10;https://deashaindia.com/collections/sarees&#10;https://example-store.com/products/dress&#10;https://shop.example.com/category/accessories"></textarea>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" id="clearBtn">
                            üóëÔ∏è Clear
                        </button>
                        <button class="btn btn-secondary" id="activeTasksBtn" style="display: none;">
                            <span id="activeTasksCount">0</span> Active Tasks
                        </button>
                        <button class="btn btn-primary" id="scrapeBtn">
                            üöÄ Grab Products
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        class FashionScraper {
            constructor() {
                this.isScrapingActive = false;
                this.currentTaskId = null;
                this.websocket = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.initializeElements();
                this.bindEvents();
                this.setupNotifications();
                // this.getDomainUrls();
                this.urls = [];
                this.currentPage = 1;
                this.domainList = document.getElementById("domainList");
                this.pagination = document.getElementById("pagination");
                this.perPageSelect = document.getElementById("perPageSelect");
                if (!this.perPageSelect) {
                    console.error("perPageSelect element not found in DOM at init");
                }

                // bind events
                document.getElementById("scrapeDomain")
                    .addEventListener("click", () => this.getDomainUrls());

                if (this.perPageSelect) {
                    this.perPageSelect.addEventListener("change", () => {
                        this.currentPage = 1;
                        this.render();
                    });
                }
            }

            initializeElements() {
                this.urlInput = document.getElementById('urlInput');
                this.scrapeBtn = document.getElementById('scrapeBtn');
                // this.scrapeBtnDomain = document.getElementById('scrapeDomain');
                this.clearBtn = document.getElementById('clearBtn');
                this.activeTasksBtn = document.getElementById('activeTasksBtn');
                this.activeTasksCount = document.getElementById('activeTasksCount');
                this.chatMessages = document.getElementById('chatMessages');
                this.maxPages = document.getElementById('maxPages');
                this.aiPagination = document.getElementById('aiPagination');
                this.aiExtraction = document.getElementById('aiExtraction');
                this.showDomain = document.getElementById('showDomain');
                this.showProducts = document.getElementById('showProducts');

                this.inputSectionurl = document.getElementById('inputSectionurl');
                this.inputSectionScrape = document.getElementById('inputSectionScrape');

                this.showDomain.checked = true;
                this.showProducts.checked = false;
                this.inputSectionScrape.classList.add('hidden');
            }

            bindEvents() {
                this.scrapeBtn.addEventListener('click', () => this.startScraping());
                // this.scrapeBtnDomain.addEventListener('click', () => this.getDomainUrls());
                this.clearBtn.addEventListener('click', () => this.clearAll());
                this.activeTasksBtn.addEventListener('click', () => this.showActiveTasksModal());
                this.showDomain.addEventListener('change', () => {
                    if (this.showDomain.checked) {
                        // this.showProducts.checked = true;
                        this.inputSectionurl.classList.remove('hidden');
                        this.inputSectionScrape.classList.add('hidden');
                    } 
                });
                this.showProducts.addEventListener('change', () => {
                    if (this.showProducts.checked) {
                        // this.showDomain.checked = false;
                        this.inputSectionScrape.classList.remove('hidden');
                         this.inputSectionurl.classList.add('hidden');
                    }
                });
                

                this.urlInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.startScraping();
                    }
                });

                this.urlInput.addEventListener('input', () => {
                    this.updateScrapeButton();
                });

                // Check for active tasks periodically
                this.startActiveTasksMonitoring();
            }

            startActiveTasksMonitoring() {
                // Check immediately
                this.updateActiveTasksDisplay();

                // Then check every 10 seconds
                setInterval(() => {
                    this.updateActiveTasksDisplay();
                }, 10000);
            }

 handleSelection() {
    console.log(this.showDomain);
      if (this.showDomain.checked) {
        this.inputSectionurl.classList.remove("hidden");
        // this.inputSectionScrape.classList.add("hidden");
      } else if (this.showProducts.checked) {
        // this.inputSectionurl.classList.remove("hidden");
        this.inputSectionScrape.classList.add("hidden");
      }
    }

            async updateActiveTasksDisplay() {
                try {
                    const response = await fetch('/api/active-tasks');
                    if (response.ok) {
                        const data = await response.json();
                        const activeCount = data.total_active || 0;

                        this.activeTasksCount.textContent = activeCount;

                        if (activeCount > 0) {
                            this.activeTasksBtn.style.display = 'inline-flex';
                            this.activeTasksBtn.classList.add('pulse-animation');
                        } else {
                            this.activeTasksBtn.style.display = 'none';
                            this.activeTasksBtn.classList.remove('pulse-animation');
                        }
                    }
                } catch (error) {
                    console.error('Error checking active tasks:', error);
                }
            }

            async showActiveTasksModal() {
                try {
                    const response = await fetch('/api/active-tasks');
                    if (response.ok) {
                        const data = await response.json();
                        const activeTasks = data.active_tasks || [];

                        if (activeTasks.length === 0) {
                            this.addMessage('‚ÑπÔ∏è No currently active tasks found.', 'system');
                            return;
                        }

                        let tasksInfo = `üìä <strong>Active Tasks (${activeTasks.length}):</strong><br><br>`;
                        activeTasks.forEach((task, index) => {
                            const startTime = new Date(task.start_time).toLocaleString();
                            const progress = task.current_progress?.percentage || 0;
                            tasksInfo += `<div style="background: rgba(139, 92, 246, 0.1); padding: 8px; border-radius: 6px; margin: 4px 0;">`;
                            tasksInfo += `<strong>${index + 1}. ${task.scraper_type.toUpperCase()}</strong><br>`;
                            tasksInfo += `<code>ID: ${task.task_id}</code><br>`;
                            tasksInfo += `Status: ${task.status} (${progress}%)<br>`;
                            tasksInfo += `URLs: ${task.urls_count} | Started: ${startTime}`;
                            tasksInfo += `</div>`;
                        });

                        this.addMessage(tasksInfo, 'system');
                    }
                } catch (error) {
                    this.addMessage('‚ùå Error fetching active tasks: ' + error.message, 'error');
                }
            }

            updateScrapeButton() {
                const hasUrls = this.urlInput.value.trim().length > 0;
                this.scrapeBtn.disabled = !hasUrls || this.isScrapingActive;
            }

            async clearAll() {
                // First, terminate any active tasks
                await this.terminateActiveTasks();

                // Clear the UI
                this.urlInput.value = '';
                this.chatMessages.innerHTML = `
                    <div class="empty-state">
                        <h3>Ready to Scrape Fashion Products</h3>
                        <p>Enter one or more e-commerce URLs below to start extracting product data with AI intelligence.</p>
                        <p><strong>Supported:</strong> Shopify, WooCommerce, and custom e-commerce sites</p>
                    </div>
                `;

                // Reset scraping state
                this.resetScrapingState();
                this.updateScrapeButton();
            }

            async terminateActiveTasks() {
                try {
                    // Get active tasks
                    const activeTasksResponse = await fetch('/api/active-tasks');
                    if (!activeTasksResponse.ok) {
                        console.log('No active tasks to terminate');
                        return;
                    }

                    const activeTasksData = await activeTasksResponse.json();
                    const activeTasks = activeTasksData.active_tasks || [];

                    if (activeTasks.length === 0) {
                        console.log('No active tasks found');
                        return;
                    }

                    // Extract task IDs
                    const taskIds = activeTasks.map(task => task.task_id);
                    console.log('üõë Terminating active tasks:', taskIds);

                    // Add notification about termination
                    this.addMessage(`üõë <strong>Terminating ${taskIds.length} active task(s)...</strong><br>Closing connections and cleaning up.`, 'system');

                    // Terminate tasks
                    const terminateResponse = await fetch('/api/terminate-tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            task_ids: taskIds,
                            reason: 'User clicked Clear button'
                        })
                    });

                    if (terminateResponse.ok) {
                        const terminateData = await terminateResponse.json();
                        console.log('‚úÖ Tasks terminated successfully:', terminateData);

                        if (terminateData.total_terminated > 0) {
                            this.addMessage(`‚úÖ <strong>Successfully terminated ${terminateData.total_terminated} task(s)</strong><br>All connections closed.`, 'success');
                        }

                        if (terminateData.failed_terminations.length > 0) {
                            console.warn('Some tasks failed to terminate:', terminateData.failed_terminations);
                        }
                    } else {
                        console.error('Failed to terminate tasks:', terminateResponse.status);
                        this.addMessage('‚ö†Ô∏è <strong>Warning:</strong> Some tasks may still be running.', 'error');
                    }

                } catch (error) {
                    console.error('Error terminating tasks:', error);
                    this.addMessage('‚ö†Ô∏è <strong>Error terminating tasks:</strong> ' + error.message, 'error');
                }
            }

            clearResults() {
                // Remove any existing progress containers or results
                const progressContainers = this.chatMessages.querySelectorAll('.progress-container, .stats-container, .products-grid');
                progressContainers.forEach(container => container.remove());
            }

            addMessage(content, type = 'system') {
                if (this.chatMessages.querySelector('.empty-state')) {
                    this.chatMessages.innerHTML = '';
                }

                const message = document.createElement('div');
                message.className = `message ${type}`;
                message.innerHTML = content;
                this.chatMessages.appendChild(message);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            async startScraping() {
                const urls = this.urlInput.value.trim();
                if (!urls) {
                    this.addMessage('‚ö†Ô∏è Please enter at least one URL to scrape.', 'error');
                    return;
                }

                const urlList = urls.split('\n').filter(url => url.trim()).map(url => url.trim());
                if (urlList.length === 0) {
                    this.addMessage('‚ö†Ô∏è Please enter valid URLs.', 'error');
                    return;
                }

                // Get settings
                const maxPages = parseInt(this.maxPages.value) || 50;
                const useAiPagination = this.aiPagination.checked;
                const aiExtractionMode = this.aiExtraction.checked;

                // Clear previous results and start fresh
                this.clearResults();
                this.isScrapingActive = true;
                this.scrapeBtn.textContent = 'AI Processing...';
                this.scrapeBtn.disabled = true;

                try {
                    // Start scraping
                    const response = await fetch('/scrape/ai', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            urls: urlList,
                            max_pages_per_url: maxPages,
                            use_ai_pagination: useAiPagination,
                            ai_extraction_mode: aiExtractionMode
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.success) {
                        this.currentTaskId = result.data.task_id;
                        this.addMessage(`
                            <div class="task-started-compact">
                                <span class="status-icon">‚úÖ</span>
                                <span class="status-text">Task started</span>
                                <span class="task-id-container">
                                    <span class="task-id-label">ID:</span>
                                    <code class="task-id-code" onclick="navigator.clipboard.writeText('${this.currentTaskId}'); this.classList.add('copied'); setTimeout(() => this.classList.remove('copied'), 2000)" title="Click to copy">${this.currentTaskId}</code>
                                </span>
                            </div>
                        `, 'success');

                        // Start monitoring progress with WebSocket
                        await this.monitorProgress();

                    } else {
                        throw new Error(result.error || 'Unknown error occurred');
                    }

                } catch (error) {
                    console.error('Error starting scraping:', error);
                    this.addMessage(`‚ùå <strong>Failed to start scraping:</strong> ${error.message}`, 'error');
                    this.resetScrapingState();
                }
            }

            setupNotifications() {
                if ('Notification' in window) {
                    Notification.requestPermission();
                }
            }

            showNotification(title, body, type = 'info') {
                if ('Notification' in window && Notification.permission === 'granted') {
                    const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
                    new Notification(`${icon} ${title}`, {
                        body: body,
                        icon: '/favicon.ico'
                    });
                }
            }

            connectWebSocket(taskId) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${taskId}`;

                console.log('üîå Connecting to WebSocket:', wsUrl);
                this.websocket = new WebSocket(wsUrl);

                this.websocket.onopen = () => {
                    console.log('üîå WebSocket connected for real-time updates');
                    this.reconnectAttempts = 0;
                    this.addMessage('üîå <strong>Real-time connection established</strong><br>Live updates enabled', 'success');
                };

                this.websocket.onmessage = (event) => {
                    console.log('üì® WebSocket message received:', event.data);
                    try {
                        const message = JSON.parse(event.data);
                        this.handleWebSocketMessage(message);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                this.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.addMessage('‚ö†Ô∏è <strong>Connection issue:</strong> Falling back to polling updates', 'error');
                };

                this.websocket.onclose = (event) => {
                    console.log('WebSocket connection closed:', event.code, event.reason);
                    if (this.isScrapingActive && this.reconnectAttempts < this.maxReconnectAttempts) {
                        this.reconnectAttempts++;
                        console.log(`üîÑ Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                        setTimeout(() => this.connectWebSocket(taskId), 2000 * this.reconnectAttempts);
                    }
                };
            }

            handleWebSocketMessage(message) {
                console.log('üîÑ Processing WebSocket message:', message.type, message.data);

                switch (message.type) {
                    case 'progress_update':
                        this.updateProgress(message.data);
                        break;
                    case 'task_completed':
                        this.handleTaskCompletion(message.data);
                        break;
                    case 'task_failed':
                        this.handleTaskFailure(message.data);
                        break;
                    case 'task_terminated':
                        this.handleTaskTermination(message.data);
                        break;
                    case 'status_update':
                        this.handleStatusUpdate(message.data);
                        break;
                    default:
                        console.log('Unknown message type:', message.type);
                }
            }

            handleTaskTermination(terminationData) {
                console.log('üõë Task terminated:', terminationData);
                this.addMessage(`üõë <strong>Task Terminated:</strong> ${terminationData.reason}<br><code>Task ID: ${terminationData.task_id}</code>`, 'error');
                this.resetScrapingState();
            }

            updateProgress(progressData) {
                console.log('üìä Updating progress:', progressData);

                const progressText = document.getElementById('progressText');
                const progressFill = document.getElementById('progressFill');
                const progressDetails = document.getElementById('progressDetails');
                const progressLog = document.getElementById('progressLog');

                if (progressText && progressFill && progressDetails) {
                    const percentage = progressData.percentage || 0;
                    const details = progressData.details || 'Processing...';

                    progressText.textContent = `${percentage}%`;
                    progressFill.style.width = `${percentage}%`;
                    progressDetails.innerHTML = `<i class="fas fa-robot"></i> ${details}`;

                    // Add stage-specific styling
                    progressFill.className = 'progress-fill';
                    if (progressData.stage === 'ai_analysis') {
                        progressFill.style.background = 'linear-gradient(90deg, var(--accent-purple), var(--accent-pink))';
                    } else if (progressData.stage === 'extraction' || progressData.stage === 'scraping_pages') {
                        progressFill.style.background = 'linear-gradient(90deg, var(--accent-blue), var(--accent-purple))';
                    } else if (progressData.stage === 'completed') {
                        progressFill.style.background = 'linear-gradient(90deg, var(--success-green), var(--accent-blue))';
                    } else {
                        progressFill.style.background = 'var(--primary-gradient)';
                    }

                    // Add detailed log entry
                    if (progressLog) {
                        this.addLogEntry(progressData.stage, details, progressData.stats);
                    }

                    console.log(`‚úÖ Progress updated: ${percentage}% - ${details}`);
                } else {
                    console.error('‚ùå Progress elements not found in DOM');
                }
            }

            addLogEntry(stage, details, stats) {
                const progressLog = document.getElementById('progressLog');
                if (!progressLog) return;

                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');

                // Determine log entry class based on content
                let entryClass = 'log-entry';
                if (details.includes('‚úÖ') || details.includes('Success') || details.includes('complete')) {
                    entryClass += ' success';
                } else if (details.includes('‚ùå') || details.includes('Failed') || details.includes('Error')) {
                    entryClass += ' error';
                } else if (stage === 'ai_analysis') {
                    entryClass += ' ai-analysis';
                } else if (stage === 'extraction') {
                    entryClass += ' extraction';
                }

                logEntry.className = entryClass;

                // Add stats if available
                let statsText = '';
                if (stats && (stats.products_found > 0 || stats.pages_analyzed > 0)) {
                    statsText = ` [Products: ${stats.products_found || 0}, Pages: ${stats.pages_analyzed || 0}]`;
                }

                logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${details}${statsText}`;

                progressLog.appendChild(logEntry);

                // Auto-scroll to bottom
                const detailedProgress = document.getElementById('detailedProgress');
                if (detailedProgress) {
                    detailedProgress.scrollTop = detailedProgress.scrollHeight;
                }

                // Limit log entries to prevent memory issues
                if (progressLog.children.length > 50) {
                    progressLog.removeChild(progressLog.firstChild);
                }
            }

            handleTaskCompletion(taskData) {
                console.log('üéâ Task completed:', taskData);
                this.showNotification('Scraping Completed!', `Found ${taskData.result?.products?.length || 0} products`);

                setTimeout(() => {
                    this.displayResults(taskData.result);
                    this.resetScrapingState();
                }, 1000);
            }

            handleTaskFailure(taskData) {
                console.log('‚ùå Task failed:', taskData);
                this.showNotification('Scraping Failed', taskData.error || 'Unknown error', 'error');
                this.addMessage(`‚ùå <strong>Scraping failed:</strong> ${taskData.error || 'Unknown error'}`, 'error');
                this.resetScrapingState();
            }

            handleStatusUpdate(statusData) {
                console.log('üìà Status update:', statusData);
                if (statusData.current_progress) {
                    this.updateProgress(statusData.current_progress);
                }
            }

            async monitorProgress() {
                // Create enhanced progress container with detailed updates
                const progressContainer = document.createElement('div');
                progressContainer.className = 'progress-container';
                progressContainer.innerHTML = `
                    <div class="progress-header">
                        <div class="progress-title">
                            <i class="fas fa-brain"></i>
                            <strong>AI Scraping Progress</strong>
                        </div>
                        <div class="progress-stats">
                            <span id="progressText" class="progress-percentage">0%</span>
                            <div class="connection-status">
                                <i class="fas fa-wifi connection-icon"></i>
                                <span>Live</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                            <div class="progress-glow"></div>
                        </div>
                    </div>
                    <div id="progressDetails" class="progress-details">
                        <i class="fas fa-robot"></i> Initializing AI agent...
                    </div>
                    <div id="detailedProgress" class="detailed-progress">
                        <div class="progress-log" id="progressLog">
                            <div class="log-entry">üöÄ AI scraping session started...</div>
                        </div>
                    </div>
                `;

                this.chatMessages.appendChild(progressContainer);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;

                // Connect WebSocket for real-time updates
                console.log('üöÄ Starting WebSocket connection for task:', this.currentTaskId);
                this.connectWebSocket(this.currentTaskId);
            }

            displayResults(result) {
                const products = result.products || [];
                const metadata = result.metadata || {};

                // Add stats
                this.addMessage(`
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-number">${products.length}</div>
                            <div class="stat-label">Products Found</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${metadata.urls_processed || 0}</div>
                            <div class="stat-label">URLs Processed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${metadata.ai_stats?.ai_extraction_success || 0}</div>
                            <div class="stat-label">AI Extractions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${metadata.total_pages_processed || 0}</div>
                            <div class="stat-label">Pages Processed</div>
                        </div>
                    </div>
                `, 'success');

                if (products.length > 0) {
                    // Store products for later use
                    this.currentProducts = products;

                    const productsHtml = `
                        <div class="products-header">
                            <div class="products-actions">
                                <button id="selectAllBtn" class="btn btn-secondary" onclick="fashionScraper.selectAllProducts()">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button id="editUploadBtn" class="btn btn-primary" style="display: none;" onclick="fashionScraper.editSelectedProducts()">
                                    <i class="fas fa-edit"></i> Edit & Upload (<span id="selectedCount">0</span>)
                                </button>
                            </div>
                        </div>
                        <div class="products-grid">
                            ${products.map((product, index) => this.createProductCard(product, index)).join('')}
                        </div>
                    `;

                    this.addMessage(`
                        <strong>üõçÔ∏è Extracted Products (${products.length})</strong>
                        ${productsHtml}
                    `, 'system');
                } else {
                    this.addMessage('‚ÑπÔ∏è No products were found in the provided URLs.', 'system');
                }
            }

            createProductCard(product, index) {
                const price = product.price ? `‚Çπ${product.price.toLocaleString()}` : 'Price not available';
                const image = product.product_images && product.product_images.length > 0
                    ? product.product_images[0]
                    : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjFGNUY5Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE1MCA4Mi4zNDMxIDE2NS4zNDMgNjcgMTgzIDY3QzIwMC42NTcgNjcgMjE2IDgyLjM0MzEgMjE2IDEwMEMyMTYgMTE3LjY1NyAyMDAuNjU3IDEzMyAxODMgMTMzQzE2NS4zNDMgMTMzIDE1MCAxMTcuNjU3IDE1MCAxMDBaIiBmaWxsPSIjQ0JENUUxIi8+CjxwYXRoIGQ9Ik0xMjAgMTMzSDE4MEwxNzAgMTUzSDE0MEwxMjAgMTMzWiIgZmlsbD0iI0NCRDVFMSIvPgo8L3N2Zz4K';

                const sizes = product.sizes && product.sizes.length > 0
                    ? product.sizes.slice(0, 5).map(size => `<span class="tag">${size}</span>`).join('')
                    : '';

                const colors = product.colors && product.colors.length > 0
                    ? product.colors.slice(0, 3).map(color => `<span class="tag">${color}</span>`).join('')
                    : '';

                const material = product.material ? `<span class="tag">${product.material}</span>` : '';

                return `
                    <div class="product-card" data-product-index="${index}">
                        <div class="product-select-overlay">
                            <input type="checkbox" class="product-checkbox" id="product-${index}" 
                                   onchange="fashionScraper.handleProductSelection()">
                            <label for="product-${index}" class="product-select-label">
                                <i class="fas fa-check"></i>
                            </label>
                        </div>
                        <img src="${image}" alt="${product.product_name}" class="product-image" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjFGNUY5Ii8+CjxwYXRoIGQ9Ik0xNTAgMTAwQzE1MCA4Mi4zNDMxIDE2NS4zNDMgNjcgMTgzIDY3QzIwMC42NTcgNjcgMjE2IDgyLjM0MzEgMjE2IDEwMEMyMTYgMTE3LjY1NyAyMDAuNjU3IDEzMyAxODMgMTMzQzE2NS4zNDMgMTMzIDE1MCAxMTcuNjU3IDE1MCAxMDBaIiBmaWxsPSIjQ0JENUUxIi8+CjxwYXRoIGQ9Ik0xMjAgMTMzSDE4MEwxNzAgMTUzSDE0MEwxMjAgMTMzWiIgZmlsbD0iI0NCRDVFMSIvPgo8L3N2Zz4K'">
                        <div class="product-info">
                            <div class="product-name">${product.product_name || 'Unnamed Product'}</div>
                            <div class="product-price">${price}</div>
                            <div class="product-details">
                                ${product.description ? product.description.substring(0, 100) + '...' : 'No description available'}
                            </div>
                            <div class="product-tags">
                                ${sizes}
                                ${colors}
                                ${material}
                            </div>
                        </div>
                    </div>
                `;
            }

            resetScrapingState() {
                this.isScrapingActive = false;
                this.currentTaskId = null;
                if (this.websocket) {
                    this.websocket.close();
                    this.websocket = null;
                }
                this.scrapeBtn.textContent = 'Grab Products';
                this.scrapeBtn.disabled = false;
            }

            handleProductSelection() {
                const checkboxes = document.querySelectorAll('.product-checkbox');
                const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;

                // Update selected count
                const selectedCountSpan = document.getElementById('selectedCount');
                if (selectedCountSpan) {
                    selectedCountSpan.textContent = selectedCount;
                }

                // Show/hide Edit & Upload button
                const editUploadBtn = document.getElementById('editUploadBtn');
                if (editUploadBtn) {
                    editUploadBtn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
                }

                // Update visual selection state
                checkboxes.forEach(checkbox => {
                    const productCard = checkbox.closest('.product-card');
                    if (productCard) {
                        if (checkbox.checked) {
                            productCard.classList.add('selected');
                        } else {
                            productCard.classList.remove('selected');
                        }
                    }
                });

                // Update Select All button text
                const selectAllBtn = document.getElementById('selectAllBtn');
                if (selectAllBtn) {
                    const allSelected = selectedCount === checkboxes.length && checkboxes.length > 0;
                    selectAllBtn.innerHTML = allSelected
                        ? '<i class="fas fa-square"></i> Deselect All'
                        : '<i class="fas fa-check-square"></i> Select All';
                }
            }

            selectAllProducts() {
                const checkboxes = document.querySelectorAll('.product-checkbox');
                const allSelected = Array.from(checkboxes).every(cb => cb.checked);

                checkboxes.forEach(checkbox => {
                    checkbox.checked = !allSelected;
                });

                this.handleProductSelection();
            }

            editSelectedProducts() {
                const checkboxes = document.querySelectorAll('.product-checkbox:checked');
                const selectedIndices = Array.from(checkboxes).map(cb =>
                    parseInt(cb.closest('.product-card').dataset.productIndex)
                );

                if (selectedIndices.length === 0) {
                    alert('Please select at least one product to edit.');
                    return;
                }

                const selectedProducts = selectedIndices.map(index => this.currentProducts[index]);

                // Store selected products in localStorage for the edit page
                localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));

                // Open edit page
                // Also store the current task ID if available
                if (this.currentTaskId) {
                    localStorage.setItem('currentTaskId', this.currentTaskId);
                }

                // Open edit page
                const url = '/edit-products';
                window.open(url, '_blank');
            }

            isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }




            async getDomainUrls() {
                const button = document.getElementById("scrapeDomain");
                try {
                    const domainurlInput = document.getElementById("domainurlInput");
                    const domainurl = domainurlInput.value.trim();
                    if (!domainurl) {
                        alert("Please enter a domain URL.");
                        return;
                    }

                    button.disabled = true;
                    button.innerHTML = "‚è≥ Loading...";

                    console.log("Fetching domain URLs for:", domainurl);

                    const response = await fetch("/api/get-domain-urls", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ base_url: domainurl }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Domain URLs fetched:", data);
                        this.urls = data.collections_with_products || [];
                        this.currentPage = 1;
                        this.render();
                    } else {
                        console.error("Failed to fetch domain URLs:", response.statusText);
                    }
                } catch (error) {
                    console.error("Error fetching domain URLs:", error);
                } finally {
                    // Reset button state
                    button.disabled = false;
                    button.innerHTML = "üöÄ Grab SubDomain";
                }
            }

            render() {
                if (!this.perPageSelect) {
                    console.error("perPageSelect element not found in DOM");
                    return;
                }

                const perPage = Number(this.perPageSelect.value);
                const total = this.urls.length;
                const totalPages = Math.ceil(total / perPage);
                const start = (this.currentPage - 1) * perPage;
                const end = start + perPage;
                const pageItems = this.urls.slice(start, end);

                // render list
                this.domainList.innerHTML = "";
                if (pageItems.length === 0) {
                    this.domainList.innerHTML = "<p>No subdomains found.</p>";
                } else {
                    pageItems.forEach((url) => {
                        const row = document.createElement("div");
                        row.classList.add("url-row");

                        // button
                        const btn = document.createElement("button");
                        btn.classList.add("url-btn");
                        btn.textContent = "üîó"; // you can use an icon or text
                        btn.addEventListener("click", () => {
                            // action when button is clicked
                            this.grabProduct(url, row);
                            // alert('Grab request for: ' + url);
                            // console.log("Grab product:", url);
                            // document.getElementById('urlInput').value = url;
                            // window.open(url, "_blank");
                        });

                        // url text
                        const span = document.createElement("span");
                        span.textContent = url;
                        span.classList.add("url-text");

                        row.appendChild(btn);
                        row.appendChild(span);
                        this.domainList.appendChild(row);
                    });
                }

                // render pagination
                this.pagination.innerHTML = "";
                if (totalPages > 1) {
                    for (let i = 1; i <= totalPages; i++) {
                        const btn = document.createElement("button");
                        btn.textContent = i;
                        if (i === this.currentPage) btn.classList.add("active");
                        btn.addEventListener("click", () => {
                            this.currentPage = i;
                            this.render();
                        });
                        this.pagination.appendChild(btn);
                    }
                }
            }




            grabProduct(url, rowEl) {
                // alert('Grab request for: ' + url);
                // console.log("Grab product:", url);
                document.getElementById('urlInput').value = url;
                this.startScraping();
            }

            // this.perPageSelect.addEventListener('change', () => { currentPage = 1; render(); });



        }




        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            window.fashionScraper = new FashionScraper();
        });
    </script>
</body>

</html>